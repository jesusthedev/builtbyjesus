---
import Base from "../../layouts/Base.astro";
import { projects } from "../../lib/projects";
import { getCollection } from "astro:content";

// Static paths
export async function getStaticPaths() {
  return projects.map((p) => ({
    params: { slug: p.slug },
    props: { project: p }
  }));
}

const { project } = Astro.props;

const statusLabel = String(project.status || "WIP");
const fmt = (d) => new Date(d).toISOString().slice(0, 10);

// Pull global logbook entries
const entriesAll = await getCollection("logbook");
const entries = entriesAll
  .filter((e) => (e.data.projects || []).includes(project.slug))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 5);

// Attempt to load STATUS.md and NOTES.md
let StatusContent = null;
let NotesContent = null;

try {
  const mod = await import(`../../content/projects/${project.slug}/STATUS.md`);
  StatusContent = mod.Content;
} catch {}

try {
  const mod = await import(`../../content/projects/${project.slug}/NOTES.md`);
  NotesContent = mod.Content;
} catch {}
---

<Base title={`${project.title} • Built by Jesus`} description={project.tagline}>
  <p style="opacity:.75; margin:0 0 10px;">
    <a href={project.type === "labs" ? "/labs" : "/work"} style="text-decoration:none;">
      ← Back to {project.type === "labs" ? "Labs" : "Work"}
    </a>
  </p>

  <h1 style="margin:0 0 6px;">{project.title}</h1>
  <p style="opacity:.8; margin:0 0 14px;">
    <strong>Status:</strong> {statusLabel}
  </p>

  {project.tagline && (
    <p style="opacity:.9; max-width:70ch;">
      {project.tagline}
    </p>
  )}

  {project.tags?.length ? (
    <>
      <h2>Tags</h2>
      <ul>
        {project.tags.map((t) => <li>{t}</li>)}
      </ul>
    </>
  ) : null}

  {project.links && (project.links.repo || project.links.demo) ? (
    <>
      <h2>Links</h2>
      <ul>
        {project.links.repo && <li><a href={project.links.repo}>Repository</a></li>}
        {project.links.demo && <li><a href={project.links.demo}>Live demo</a></li>}
      </ul>
    </>
  ) : null}

  {StatusContent && (
    <>
      <hr style="margin:22px 0; opacity:.3;" />
      <h2>Current status</h2>
      <StatusContent />
    </>
  )}

  {NotesContent && (
    <>
      <hr style="margin:22px 0; opacity:.3;" />
      <h2>Notes</h2>
      <NotesContent />
    </>
  )}

  <hr style="margin:22px 0; opacity:.3;" />

  <h2>Latest logbook</h2>
  {entries.length === 0 ? (
    <p style="opacity:.75;"><em>No logbook entries tagged for this project yet.</em></p>
  ) : (
    <ul>
      {entries.map((e) => (
        <li>
          <a href={`/logbook/${e.slug}`}>
            {fmt(e.data.date)} • {e.data.title}
          </a>
        </li>
      ))}
    </ul>
  )}
</Base>
