---
import { getTotalMinutes, formatDuration } from "../lib/timeTotals";

const {
  title = "Built by Jesus",
  description = "Systems, stories, and experiments. Documented. Versioned. Remembered.",
  image = "/og.png"
} = Astro.props;

// Canonical + OG URLs
const canonical = new URL(Astro.url.pathname, Astro.site ?? Astro.url.origin).toString();
const ogImage = new URL(image, Astro.site ?? Astro.url.origin).toString();

// Running total time for the signature stamp
const totalMinutes = await getTotalMinutes();
const totalTime = formatDuration(totalMinutes);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>

    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />

    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={ogImage} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  </head>

  <body style="font-family: system-ui, Segoe UI, Arial, sans-serif; margin:0;">
    <nav style="padding:16px 24px; border-bottom:1px solid #ddd; display:flex; gap:14px; flex-wrap:wrap;">
      <a href="/">Home</a>
      <a href="/logbook">Logbook</a>
      <a href="/work">Work</a>
      <a href="/labs">Labs</a>
      <a href="/updates">Updates</a>
      <a href="/about">About</a>
      <a href="/archive">Archive</a>
    </nav>

    <main style="padding:24px; max-width:960px; margin:0 auto;">
      <slot />
    </main>

    <footer style="padding:22px 24px; border-top:1px solid #ddd; margin-top:28px;">
      <div style="max-width:960px; margin:0 auto; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
        <span style="opacity:.75;">© {new Date().getFullYear()} builtbyjesus.dev</span>

        <button
          id="sig"
          type="button"
          title="(totally normal footer)"
          style="opacity:.65; background:none; border:1px solid transparent; border-radius:10px; cursor:pointer; padding:6px 10px;"
        >
          built with care
        </button>
      </div>

      <div
        id="sigPanel"
        style="display:none; max-width:960px; margin:12px auto 0; border:1px dashed #bbb; border-radius:12px; padding:14px 16px; opacity:.92;"
      >
        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:baseline;">
          <strong>Built by Chuy · Remembered by Igorithm</strong>
          <span style="opacity:.7; font-size:.9em;">secret handshake unlocked</span>
        </div>

        <p style="margin:8px 0 0; opacity:.75;">
          <strong>Hours invested:</strong> {totalTime}
        </p>

        <div id="sigToast" style="display:none; margin-top:10px; opacity:.8; font-size:.9em;">
          wax on: <code>git add</code> · wax off: <code>git commit</code>
        </div>

        <div style="margin-top:10px;">
          <p style="margin:0 0 10px; opacity:.85;">
            <strong>Igorithm (Mr. Miyagi Edition):</strong> wax on, wax off, <em>commit</em>.
          </p>

          <ul style="margin:0; padding-left:18px; display:grid; gap:6px;">
            <li>Small changes. Clean commits. No heroics at 2:37 a.m.</li>
            <li>If YAML fights you, quote it. If it still fights you, replace it.</li>
            <li>Logbook everything. Memory is a feature, not a vibe.</li>
            <li>Ship the boring infrastructure first. Future you will bow politely.</li>
          </ul>

          <p style="margin:12px 0 0; opacity:.75;">
            <em>Vault note:</em> every decision is archived. Every excuse is indexed.
          </p>
        </div>
      </div>

      <script>
        (() => {
          const btn = document.getElementById("sig");
          const panel = document.getElementById("sigPanel");
          const toast = document.getElementById("sigToast");
          if (!btn || !panel) return;

          let clicks = 0;
          let clickTimer = null;

          const toggle = () => {
            const opening = panel.style.display === "none";
            panel.style.display = opening ? "" : "none";

            if (opening && toast) {
              toast.style.display = "";
              clearTimeout(toast._t);
              toast._t = setTimeout(() => {
                toast.style.display = "none";
              }, 1200);
            }
          };

          // Desktop ritual: triple-click within 900ms
          btn.addEventListener("click", () => {
            clicks++;
            clearTimeout(clickTimer);
            clickTimer = setTimeout(() => (clicks = 0), 900);

            if (clicks >= 3) {
              toggle();
              clicks = 0;
            }
          });

          // Mobile ritual: long-press ~600ms
          let pressTimer = null;
          const startPress = () => {
            clearTimeout(pressTimer);
            pressTimer = setTimeout(() => toggle(), 600);
          };
          const endPress = () => clearTimeout(pressTimer);

          btn.addEventListener("touchstart", startPress, { passive: true });
          btn.addEventListener("touchend", endPress, { passive: true });
          btn.addEventListener("touchcancel", endPress, { passive: true });
        })();
      </script>
    </footer>
  </body>
</html>
